# Admin Backend Service

## ğŸ”· Diamond Pattern Support

**é‡è¦æ›´æ–°**ï¼šNFTManager å·²è¿ç§»åˆ° Diamond Pattern (EIP-2535)ï¼Œæ‰€æœ‰åŠŸèƒ½æ•´åˆåœ¨ä¸€ä¸ªåˆçº¦ä¸­ã€‚

### å¿«é€Ÿå¼€å§‹

1. **æ›´æ–° ABI æ–‡ä»¶**ï¼ˆå·²è‡ªåŠ¨ç”Ÿæˆï¼‰ï¼š
   ```bash
   npm run generate-abi
   ```

2. **æ›´æ–°ç¯å¢ƒå˜é‡**ï¼š
   ```bash
   # ä½¿ç”¨éƒ¨ç½²è„šæœ¬ç”Ÿæˆçš„ç¯å¢ƒæ–‡ä»¶
   cp ../contracts/env.testnet .env
   # æˆ–
   cp ../contracts/env.mainnet .env
   ```

3. **éªŒè¯è¿æ¥**ï¼š
   ```bash
   npm run verify-diamond
   ```

### è¯¦ç»†æ–‡æ¡£

è¯·å‚é˜… [DIAMOND_PATTERN_GUIDE.md](./DIAMOND_PATTERN_GUIDE.md) äº†è§£å®Œæ•´çš„ä½¿ç”¨æŒ‡å—ã€‚

**å¥½æ¶ˆæ¯**ï¼šåç«¯ä»£ç æ— éœ€ä¿®æ”¹ï¼æ‰€æœ‰å‡½æ•°è°ƒç”¨æ–¹å¼ä¿æŒä¸å˜ã€‚

---

## Overview

Backend service for the admin panel, providing RESTful APIs for management interface. Uses independent backend architecture to support complex hierarchical queries, statistics, and data analysis.

## Tech Stack

- **Framework**: **NestJS** (Recommended)
- **Language**: TypeScript
- **Database**: PostgreSQL
- **ORM**: Prisma (Recommended) or TypeORM
- **Authentication**: JWT Token (@nestjs/jwt)
- **Contract Interaction**: ethers.js (direct contract calls with admin private key)

### Why NestJS?

âœ… **Better TypeScript Support**: Complete type inference and decorator support  
âœ… **Modular Architecture**: Clear module division for easier maintenance  
âœ… **Dependency Injection**: Better code organization and testing  
âœ… **Built-in Features**: Authentication, validation, interceptors out of the box  
âœ… **Suitable for Complex Business Logic**: Hierarchical queries, statistics, etc. are easier to organize  
âœ… **Enterprise-Grade Framework**: Better for long-term maintenance of large projects

### Express.js Alternative

If the team is more familiar with Express.js, it can also be used:
- **Advantages**: Lighter weight, gentler learning curve, mature ecosystem
- **Disadvantages**: Requires manual code structure organization, lacks built-in features

## Project Structure

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts              # Application entry point
â”‚   â”œâ”€â”€ app.module.ts        # Root module
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ auth/            # Authentication module
â”‚   â”‚   â”œâ”€â”€ invite-codes/    # Invite code management
â”‚   â”‚   â”œâ”€â”€ users/           # User hierarchical queries
â”‚   â”‚   â”œâ”€â”€ nfts/            # NFT tracing
â”‚   â”‚   â”œâ”€â”€ whitelist/       # Whitelist management
â”‚   â”‚   â”œâ”€â”€ batches/         # Batch management
â”‚   â”‚   â””â”€â”€ stats/           # Statistics
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ guards/          # Authentication guards
â”‚   â”‚   â”œâ”€â”€ decorators/      # Decorators
â”‚   â”‚   â””â”€â”€ filters/         # Exception filters
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ database.ts      # Database configuration
â”‚       â””â”€â”€ contract.ts       # Contract configuration
â”œâ”€â”€ prisma/                  # Prisma schema (if using Prisma)
â”œâ”€â”€ .env.example            # Environment variables example
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## Core Features

### 1. Authentication Module
- Admin login (verify contract owner)
- JWT Token generation and validation
- Permission control

### 2. Invite Code Management
- Get invite code list (with pagination and filtering)
- Get invite code details
- Query child invite codes (recursive)
- Approve/reject applications
- Revoke invite codes

### 3. User Hierarchical Queries (Core Feature)
- Query user's direct children
- Recursively query all descendants
- Get user's invite code tree structure
- User statistics

### 4. NFT Tracing
- Query NFT's invite code chain
- Query all NFTs generated by root invite code
- Query all NFTs of a user

### 5. Whitelist Management
- Get whitelist
- Batch add to whitelist (call contract)
- Remove from whitelist (call contract)

### 6. Batch Management
- Get batch list
- Create batch (call contract)
- Activate/deactivate batch (call contract)

### 7. Statistics
- Overview statistics
- Invite code statistics
- NFT statistics
- User statistics

## Environment Variables

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/nft_db

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# Contract Configuration
NFT_MANAGER_ADDRESS=0x...
ENCLAVE_TOKEN_ADDRESS=0x...
USDT_TOKEN_ADDRESS=0x...
RPC_URL=https://...

# Admin Private Key (for contract calls)
ADMIN_PRIVATE_KEY=0x...

# Service Port
PORT=3001
```

## API Endpoints

For detailed API design, refer to the "III. Admin Architecture" section in `../frontend/REFACTOR_PLAN.md`.

Main endpoints:
- `POST /api/admin/auth/login` - Admin login
- `GET /api/admin/users/:address/descendants` - Query all descendants of a user
- `GET /api/admin/invite-codes/:id/descendants` - Query all descendants of an invite code
- `GET /api/admin/nfts/:id/trace` - NFT tracing
- `GET /api/admin/stats/overview` - Overview statistics

## Development

```bash
# Install dependencies
npm install

# Development mode
npm run dev

# Build
npm run build

# Production mode
npm run start:prod
```

## Database Migration

```bash
# If using Prisma
npx prisma migrate dev

# If using TypeORM
npm run migration:run
```

## Overview

Backend service for the admin panel, providing RESTful APIs for management interface. Uses independent backend architecture to support complex hierarchical queries, statistics, and data analysis.

## Tech Stack

- **Framework**: **NestJS** (Recommended)
- **Language**: TypeScript
- **Database**: PostgreSQL
- **ORM**: Prisma (Recommended) or TypeORM
- **Authentication**: JWT Token (@nestjs/jwt)
- **Contract Interaction**: ethers.js (direct contract calls with admin private key)

### Why NestJS?

âœ… **Better TypeScript Support**: Complete type inference and decorator support  
âœ… **Modular Architecture**: Clear module division for easier maintenance  
âœ… **Dependency Injection**: Better code organization and testing  
âœ… **Built-in Features**: Authentication, validation, interceptors out of the box  
âœ… **Suitable for Complex Business Logic**: Hierarchical queries, statistics, etc. are easier to organize  
âœ… **Enterprise-Grade Framework**: Better for long-term maintenance of large projects

### Express.js Alternative

If the team is more familiar with Express.js, it can also be used:
- **Advantages**: Lighter weight, gentler learning curve, mature ecosystem
- **Disadvantages**: Requires manual code structure organization, lacks built-in features

## Project Structure

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts              # Application entry point
â”‚   â”œâ”€â”€ app.module.ts        # Root module
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ auth/            # Authentication module
â”‚   â”‚   â”œâ”€â”€ invite-codes/    # Invite code management
â”‚   â”‚   â”œâ”€â”€ users/           # User hierarchical queries
â”‚   â”‚   â”œâ”€â”€ nfts/            # NFT tracing
â”‚   â”‚   â”œâ”€â”€ whitelist/       # Whitelist management
â”‚   â”‚   â”œâ”€â”€ batches/         # Batch management
â”‚   â”‚   â””â”€â”€ stats/           # Statistics
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ guards/          # Authentication guards
â”‚   â”‚   â”œâ”€â”€ decorators/      # Decorators
â”‚   â”‚   â””â”€â”€ filters/         # Exception filters
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ database.ts      # Database configuration
â”‚       â””â”€â”€ contract.ts       # Contract configuration
â”œâ”€â”€ prisma/                  # Prisma schema (if using Prisma)
â”œâ”€â”€ .env.example            # Environment variables example
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## Core Features

### 1. Authentication Module
- Admin login (verify contract owner)
- JWT Token generation and validation
- Permission control

### 2. Invite Code Management
- Get invite code list (with pagination and filtering)
- Get invite code details
- Query child invite codes (recursive)
- Approve/reject applications
- Revoke invite codes

### 3. User Hierarchical Queries (Core Feature)
- Query user's direct children
- Recursively query all descendants
- Get user's invite code tree structure
- User statistics

### 4. NFT Tracing
- Query NFT's invite code chain
- Query all NFTs generated by root invite code
- Query all NFTs of a user

### 5. Whitelist Management
- Get whitelist
- Batch add to whitelist (call contract)
- Remove from whitelist (call contract)

### 6. Batch Management
- Get batch list
- Create batch (call contract)
- Activate/deactivate batch (call contract)

### 7. Statistics
- Overview statistics
- Invite code statistics
- NFT statistics
- User statistics

## Environment Variables

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/nft_db

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# Contract Configuration
NFT_MANAGER_ADDRESS=0x...
ENCLAVE_TOKEN_ADDRESS=0x...
USDT_TOKEN_ADDRESS=0x...
RPC_URL=https://...

# Admin Private Key (for contract calls)
ADMIN_PRIVATE_KEY=0x...

# Service Port
PORT=3001
```

## API Endpoints

For detailed API design, refer to the "III. Admin Architecture" section in `../frontend/REFACTOR_PLAN.md`.

Main endpoints:
- `POST /api/admin/auth/login` - Admin login
- `GET /api/admin/users/:address/descendants` - Query all descendants of a user
- `GET /api/admin/invite-codes/:id/descendants` - Query all descendants of an invite code
- `GET /api/admin/nfts/:id/trace` - NFT tracing
- `GET /api/admin/stats/overview` - Overview statistics

## Development

```bash
# Install dependencies
npm install

# Development mode
npm run dev

# Build
npm run build

# Production mode
npm run start:prod
```

## Database Migration

```bash
# If using Prisma
npx prisma migrate dev

# If using TypeORM
npm run migration:run
```
