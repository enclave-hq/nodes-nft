# Admin Backend Service

## Overview

Backend service for the admin panel, providing RESTful APIs for management interface. Uses independent backend architecture to support complex hierarchical queries, statistics, and data analysis.

## Tech Stack

- **Framework**: **NestJS** (Recommended)
- **Language**: TypeScript
- **Database**: PostgreSQL
- **ORM**: Prisma (Recommended) or TypeORM
- **Authentication**: JWT Token (@nestjs/jwt)
- **Contract Interaction**: ethers.js (direct contract calls with admin private key)

### Why NestJS?

✅ **Better TypeScript Support**: Complete type inference and decorator support  
✅ **Modular Architecture**: Clear module division for easier maintenance  
✅ **Dependency Injection**: Better code organization and testing  
✅ **Built-in Features**: Authentication, validation, interceptors out of the box  
✅ **Suitable for Complex Business Logic**: Hierarchical queries, statistics, etc. are easier to organize  
✅ **Enterprise-Grade Framework**: Better for long-term maintenance of large projects

### Express.js Alternative

If the team is more familiar with Express.js, it can also be used:
- **Advantages**: Lighter weight, gentler learning curve, mature ecosystem
- **Disadvantages**: Requires manual code structure organization, lacks built-in features

## Project Structure

```
backend/
├── src/
│   ├── main.ts              # Application entry point
│   ├── app.module.ts        # Root module
│   ├── modules/
│   │   ├── auth/            # Authentication module
│   │   ├── invite-codes/    # Invite code management
│   │   ├── users/           # User hierarchical queries
│   │   ├── nfts/            # NFT tracing
│   │   ├── whitelist/       # Whitelist management
│   │   ├── batches/         # Batch management
│   │   └── stats/           # Statistics
│   ├── common/
│   │   ├── guards/          # Authentication guards
│   │   ├── decorators/      # Decorators
│   │   └── filters/         # Exception filters
│   └── config/
│       ├── database.ts      # Database configuration
│       └── contract.ts       # Contract configuration
├── prisma/                  # Prisma schema (if using Prisma)
├── .env.example            # Environment variables example
├── package.json
└── tsconfig.json
```

## Core Features

### 1. Authentication Module
- Admin login (verify contract owner)
- JWT Token generation and validation
- Permission control

### 2. Invite Code Management
- Get invite code list (with pagination and filtering)
- Get invite code details
- Query child invite codes (recursive)
- Approve/reject applications
- Revoke invite codes

### 3. User Hierarchical Queries (Core Feature)
- Query user's direct children
- Recursively query all descendants
- Get user's invite code tree structure
- User statistics

### 4. NFT Tracing
- Query NFT's invite code chain
- Query all NFTs generated by root invite code
- Query all NFTs of a user

### 5. Whitelist Management
- Get whitelist
- Batch add to whitelist (call contract)
- Remove from whitelist (call contract)

### 6. Batch Management
- Get batch list
- Create batch (call contract)
- Activate/deactivate batch (call contract)

### 7. Statistics
- Overview statistics
- Invite code statistics
- NFT statistics
- User statistics

## Environment Variables

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/nft_db

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# Contract Configuration
NFT_MANAGER_ADDRESS=0x...
ENCLAVE_TOKEN_ADDRESS=0x...
USDT_TOKEN_ADDRESS=0x...
RPC_URL=https://...

# Admin Private Key (for contract calls)
ADMIN_PRIVATE_KEY=0x...

# Service Port
PORT=3001
```

## API Endpoints

For detailed API design, refer to the "III. Admin Architecture" section in `../frontend/REFACTOR_PLAN.md`.

Main endpoints:
- `POST /api/admin/auth/login` - Admin login
- `GET /api/admin/users/:address/descendants` - Query all descendants of a user
- `GET /api/admin/invite-codes/:id/descendants` - Query all descendants of an invite code
- `GET /api/admin/nfts/:id/trace` - NFT tracing
- `GET /api/admin/stats/overview` - Overview statistics

## Development

```bash
# Install dependencies
npm install

# Development mode
npm run dev

# Build
npm run build

# Production mode
npm run start:prod
```

## Database Migration

```bash
# If using Prisma
npx prisma migrate dev

# If using TypeORM
npm run migration:run
```

## Overview

Backend service for the admin panel, providing RESTful APIs for management interface. Uses independent backend architecture to support complex hierarchical queries, statistics, and data analysis.

## Tech Stack

- **Framework**: **NestJS** (Recommended)
- **Language**: TypeScript
- **Database**: PostgreSQL
- **ORM**: Prisma (Recommended) or TypeORM
- **Authentication**: JWT Token (@nestjs/jwt)
- **Contract Interaction**: ethers.js (direct contract calls with admin private key)

### Why NestJS?

✅ **Better TypeScript Support**: Complete type inference and decorator support  
✅ **Modular Architecture**: Clear module division for easier maintenance  
✅ **Dependency Injection**: Better code organization and testing  
✅ **Built-in Features**: Authentication, validation, interceptors out of the box  
✅ **Suitable for Complex Business Logic**: Hierarchical queries, statistics, etc. are easier to organize  
✅ **Enterprise-Grade Framework**: Better for long-term maintenance of large projects

### Express.js Alternative

If the team is more familiar with Express.js, it can also be used:
- **Advantages**: Lighter weight, gentler learning curve, mature ecosystem
- **Disadvantages**: Requires manual code structure organization, lacks built-in features

## Project Structure

```
backend/
├── src/
│   ├── main.ts              # Application entry point
│   ├── app.module.ts        # Root module
│   ├── modules/
│   │   ├── auth/            # Authentication module
│   │   ├── invite-codes/    # Invite code management
│   │   ├── users/           # User hierarchical queries
│   │   ├── nfts/            # NFT tracing
│   │   ├── whitelist/       # Whitelist management
│   │   ├── batches/         # Batch management
│   │   └── stats/           # Statistics
│   ├── common/
│   │   ├── guards/          # Authentication guards
│   │   ├── decorators/      # Decorators
│   │   └── filters/         # Exception filters
│   └── config/
│       ├── database.ts      # Database configuration
│       └── contract.ts       # Contract configuration
├── prisma/                  # Prisma schema (if using Prisma)
├── .env.example            # Environment variables example
├── package.json
└── tsconfig.json
```

## Core Features

### 1. Authentication Module
- Admin login (verify contract owner)
- JWT Token generation and validation
- Permission control

### 2. Invite Code Management
- Get invite code list (with pagination and filtering)
- Get invite code details
- Query child invite codes (recursive)
- Approve/reject applications
- Revoke invite codes

### 3. User Hierarchical Queries (Core Feature)
- Query user's direct children
- Recursively query all descendants
- Get user's invite code tree structure
- User statistics

### 4. NFT Tracing
- Query NFT's invite code chain
- Query all NFTs generated by root invite code
- Query all NFTs of a user

### 5. Whitelist Management
- Get whitelist
- Batch add to whitelist (call contract)
- Remove from whitelist (call contract)

### 6. Batch Management
- Get batch list
- Create batch (call contract)
- Activate/deactivate batch (call contract)

### 7. Statistics
- Overview statistics
- Invite code statistics
- NFT statistics
- User statistics

## Environment Variables

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/nft_db

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# Contract Configuration
NFT_MANAGER_ADDRESS=0x...
ENCLAVE_TOKEN_ADDRESS=0x...
USDT_TOKEN_ADDRESS=0x...
RPC_URL=https://...

# Admin Private Key (for contract calls)
ADMIN_PRIVATE_KEY=0x...

# Service Port
PORT=3001
```

## API Endpoints

For detailed API design, refer to the "III. Admin Architecture" section in `../frontend/REFACTOR_PLAN.md`.

Main endpoints:
- `POST /api/admin/auth/login` - Admin login
- `GET /api/admin/users/:address/descendants` - Query all descendants of a user
- `GET /api/admin/invite-codes/:id/descendants` - Query all descendants of an invite code
- `GET /api/admin/nfts/:id/trace` - NFT tracing
- `GET /api/admin/stats/overview` - Overview statistics

## Development

```bash
# Install dependencies
npm install

# Development mode
npm run dev

# Build
npm run build

# Production mode
npm run start:prod
```

## Database Migration

```bash
# If using Prisma
npx prisma migrate dev

# If using TypeORM
npm run migration:run
```
